<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 얼굴 랜드마크 분석</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        body { background-color: #f8fafc; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { background: white; width: 100%; max-width: 600px; padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        h1 { font-size: 1.5rem; color: #1e293b; margin-bottom: 8px; }
        .subtitle { font-size: 0.9rem; color: #64748b; margin-bottom: 24px; }
        .upload-area { width: 100%; min-height: 250px; background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 16px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; overflow: hidden; position: relative; }
        .upload-area:hover { background: #e2e8f0; border-color: #94a3b8; }
        .upload-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .upload-text { font-size: 0.9rem; color: #475569; }
        canvas { max-width: 100%; border-radius: 12px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 14px; margin-top: 20px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background: #2563eb; }
        #status { margin-top: 15px; font-weight: 600; color: #3b82f6; min-height: 24px; font-size: 0.9rem; }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s infinite linear; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧬 AI 얼굴 랜드마크 분석</h1>
        <p class="subtitle">MediaPipe를 활용한 실시간 얼굴 특징점 추출</p>
        <div class="upload-area" id="dropZone">
            <div id="placeholder">
                <span class="upload-icon">📂</span>
                <p class="upload-text">사진을 클릭하거나 드래그하세요</p>
            </div>
            <canvas id="outputCanvas"></canvas>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
        </div>
        <div id="status">AI 모델 로딩 중...</div>
        <button class="btn" id="analyzeBtn" disabled><div class="loading" id="spinner"></div>모델 준비 중</button>
    </div>
    <script type="module">
        import { FaceLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";
        
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        const placeholder = document.getElementById('placeholder');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const status = document.getElementById('status');
        const spinner = document.getElementById('spinner');

        let faceLandmarker, drawingUtils, uploadedImage;

        async function init() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" },
                    outputFaceBlendshapes: true, runningMode: "IMAGE", numFaces: 1
                });
                drawingUtils = new DrawingUtils(ctx);
                status.innerText = "이미지를 업로드해주세요."; status.style.color = "#475569";
                analyzeBtn.innerText = "분석하기"; analyzeBtn.disabled = true; spinner.style.display = "none";
            } catch(e) { console.error(e); status.innerText = "모델 로드 실패"; status.style.color = "red"; }
        }
        init();

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = e => { e.preventDefault(); dropZone.style.background = "#e2e8f0"; };
        dropZone.ondragleave = e => { e.preventDefault(); dropZone.style.background = "#f1f5f9"; };
        dropZone.ondrop = e => { e.preventDefault(); if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = e => { if(e.target.files.length) handleFile(e.target.files[0]); };

        function handleFile(file) {
            if(!file.type.startsWith('image/')) return alert('이미지 파일만 가능합니다.');
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    uploadedImage = img;
                    const scale = Math.min(1, 540 / img.width);
                    canvas.width = img.width * scale; canvas.height = img.height * scale;
                    ctx.clearRect(0,0,canvas.width,canvas.height);
                    ctx.drawImage(img, 0,0,canvas.width,canvas.height);
                    placeholder.style.display = 'none'; canvas.style.display = 'block';
                    status.innerText = "분석 버튼을 눌러주세요."; status.style.color = "#3b82f6";
                    if(faceLandmarker) analyzeBtn.disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        analyzeBtn.onclick = async () => {
            if(!faceLandmarker || !uploadedImage) return;
            status.innerText = "분석 중..."; analyzeBtn.disabled = true;
            const results = await faceLandmarker.detect(canvas);
            if(results.faceLandmarks.length > 0) {
                status.innerText = "✅ 랜드마크 검출 성공!"; status.style.color = "#10b981";
                for(const landmarks of results.faceLandmarks) {
                    drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_TESSELATION, { color: "#C0C0C070", lineWidth: 1 });
                    drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYE, { color: "#FF3030" });
                    drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_LEFT_EYE, { color: "#30FF30" });
                    drawingUtils.drawConnectors(landmarks, FaceLandmarker.FACE_LANDMARKS_FACE_OVAL, { color: "#E0E0E0" });
                }
            } else {
                status.innerText = "❌ 얼굴을 찾을 수 없습니다."; status.style.color = "#ef4444";
            }
            analyzeBtn.innerText = "다른 사진 분석하기"; analyzeBtn.disabled = false;
        };
    </script>
</body>
</html>
